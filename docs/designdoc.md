# システム全体設計

## 目的

`wise` は CLI ベースのデータ分析エージェントであり、自然言語による対話を通じて BigQuery のクエリ生成、実行、可視化、レポート作成を自動化する。

## アーキテクチャ概要

```
┌───────────┐       ┌─────────────┐       ┌──────────┐
 │ CLI / Chat│──────▶│  LLM Engine │──────▶│BigQuery  │
└────┬───────┘       └─────┬───────┘       └────┬─────┘
     │                      │                   │
     │                      │                   │
     ▼                      ▼                   ▼
Setup Wizard          Metadata Manager      Data Store
     │                      │                   │
     ▼                      ▼                   ▼
Login/OAuth            SQL Generator         File Output
                        ▲
                        │
                 Metadata Enhancer
```

各コンポーネントは次の役割を持つ：

- **CLI / Chat インターフェース**: ユーザーからの自然言語入力を受け取り、指示結果を表示する。
- **LLM Engine**: 入力とメタデータを元に SQL を生成し、ユーザーに提示する。分析や可視化向けのプロンプトを扱うモジュールに分割される。
- **BigQuery API クライアント**: 認証済みアカウントで SQL を実行し、結果を取得する。また、メタデータ取得（datasets/tables/schema/samples）も提供する。
- **Metadata Manager**: BigQuery クライアントから取得したスナップショットを用いて、テーブル構造やサンプル値を `metadata.md` としてレンダリング・保存する。
- **Metadata Enhancer（メタデータ補足モジュール）**: 機械的に取得された列名・サンプル値を分析し、各カラムの意味・単位・代表値/カテゴリ例・同義語/エイリアスを推定してメタデータに追記する（ユーザーの手動編集を前提）。
- **Data Store**: クエリ結果やメタデータ、可視化画像をフォルダに保存する。
- **Analysis Processor**: 保存済み CSV を読み込み、LLM を介して示唆を Markdown に出力する。
- **Visualization Engine**: 指示に応じてグラフを描画し、画像として保存する。

## 起動と認証フロー

1. パッケージマネージャーでインストール後、`wise` コマンドを実行するとウェルカムメッセージと共にチャットを開始する。
2. 初回実行時にはセットアップウィザードが起動し、ブラウザで Google 認証（OAuth）を行い、取得したリフレッシュトークンと email を保存する。BigQuery のプロジェクト選択はここでは行わない。
3. 再ログインは `/login` または `wise login` を利用し、保存済みリフレッシュトークンを用いた再認証のみを行う。
4. BigQuery のプロジェクト選択は `/init` 実行時に CLI 上で行い、選択したプロジェクト配下のデータセットに対する読み込み権限を確認する。

## メタデータ生成

- `/init` または `wise init` を実行すると、CLI 上でアクセス可能な BigQuery プロジェクト一覧を提示し、ユーザーが選択したプロジェクト配下のすべてのデータセットについてテーブル構造を取得してカラム情報やリレーションを含むメタデータを `metadata.md` として生成する。
- 取得対象として列挙したプロジェクトおよびデータセットの情報はメタデータに保存され、後続のクエリ生成・分析フローで参照される。
- メタデータはユーザーが編集可能であり、列名とサンプル値の両方を保持する。
- 生成後にメタデータ補足モジュールが走り、各カラムの意味や単位、代表値・カテゴリ例、同義語・エイリアスなどの補足情報を自動付与する。

## クエリ生成と実行

1. ユーザーがチャット欄に自然言語で質問を入力すると、LLM Engine がメタデータを参照して SQL を生成する。
2. 生成された SQL はユーザーに提示され、即時実行するかフィードバックするかを選択できる。
3. SQL 実行後、上位 5 行（10 行未満なら全行）を CLI に表示する。
4. CSV 書き出しを提案し、承諾された場合は目的を要約したフォルダを作成し、CSV と実行クエリを保存する。

## 分析モード

- `@` を用いてフォルダを指定し、追加指示を与えることで分析モードに入る。
- LLM はフォルダ内の CSV や画像を読み込み、示唆や考察をマークダウンとして同フォルダに出力する。

## 可視化モード

- `@` を用いて対象フォルダを指定し、可視化の指示を行う。
- 生成されたチャート画像は同フォルダに保存される。

## プログラムファイル構造

```
wise/
 ├─ __init__.py          # パッケージ初期化
 ├─ cli.py               # CLI エントリーポイント
 ├─ chat/                # チャットセッション管理
 │   ├─ session.py       # ユーザーとの対話ループと会話ログ保存
 │   └─ commands.py      # `/login` や `/init` などのコマンド実装
 ├─ llm/
 │   ├─ base.py          # LLM 共通ラッパー
 │   ├─ metadata.py      # メタデータ 生成プロンプト
 │   ├─ metadata_enhance.py # メタデータ補足プロンプト/推定ロジック
 │   ├─ sql.py           # SQL 生成プロンプト
 │   ├─ analysis.py      # データ分析プロンプト
 │   └─ visualize.py     # 可視化指示プロンプト
 ├─ analysis/
 │   └─ runner.py        # LLM を用いた分析の実行
 ├─ visualization/
 │   └─ plot.py          # グラフ生成ロジック
 ├─ bq/
 │   └─ client.py        # BigQuery API クライアント
 ├─ metadata/
 │   └─ manager.py       # メタデータ生成・更新ロジック
 ├─ datastore/
 │   └─ files.py         # 結果ファイルの保存・読み込み
 └─ db/
     └─ models.py        # 内部 DB へのアクセスラッパー
```

## 内部 DB 構造

認証情報やチャット履歴、分析履歴を保持するために SQLite を利用し、`wise.db` に次のテーブルを持つ。

- `accounts`
  - `id`: 主キー
  - `email`: Google アカウント
  - `refresh_token`: OAuth リフレッシュトークン
- `sessions`
  - `id`: 主キー
  - `account_id`: `accounts` への外部キー
  - `started_at`: セッション開始日時
- `messages`
  - `id`: 主キー
  - `session_id`: `sessions` への外部キー
  - `role`: `user`/`assistant`/`system`
  - `content`: メッセージ本文
  - `created_at`: 送信日時

## データ保存構造

```
project/
 └─ metadata.md # PJが保有するデータセットとその配下のテーブルについての説明
 └─ analyses/
    └─ {#summary}/ # 何についての分析かのタイトル
       ├─ metadata.md # 実行したSQLと保存されたテーブルについてのメタデータ
       ├─ result.csv # 実行結果のテーブル
       ├─ analysis.md # このフォルダで実行されている分析について記述したレポート
       └─ visualization_{#summary}.png # テーブルを指示に従って可視化したもの。1テーブルにつき複数可視化される
```

## 将来の拡張

- 追加のデータソースや BI ツール連携
- 分析テンプレートの共有機能
- 複数ユーザーでのコラボレーション
