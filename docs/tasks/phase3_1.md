## フェーズ 3: メタデータ生成機能

1.

## 目的

**`/init` コマンド実装**

- 指定データセットのテーブル構造・サンプル値を取得。
- `metadata/manager.py` で Markdown 形式の `data.md` を生成する。
- 既存メタデータの更新・再生成にも対応。

## ステータス

completed

## 実装計画

- CLI から `/init` を受け付ける導線を整える

  - `chat/commands.py` で `/init` をハンドリングし、専用の実装に委譲する
  - セッション開始時に既存アカウントとリフレッシュトークンがあることを確認し、未設定なら `/login` を促す文言を返す
  - 対話中に進行状況を表示しながら処理できるよう、CLI は段階ごとのメッセージを出力する

- BigQuery プロジェクト・データセットの選択処理

  - `bq/client.py` に認証済みセッションから利用可能なプロジェクト一覧を取得するヘルパーを追加する（`projects` エンドポイントを使用）
  - プロジェクト選択後に `BQClient` を生成し、`list_datasets()` で得られる全データセットを対象として処理する（一覧表示のみ行い個別選択はしない）
  - 大量データセット時の確認ダイアログやキャンセル手段（例: 空入力で中断、`Ctrl+C` 捕捉）を定義する

- メタデータ収集のロジック

  - 選択したプロジェクト配下の全データセットを `bq.client.metadata_snapshot()` に渡し、各テーブルのスキーマとサンプル行（`sample_n` 既定値 3）を取得する
  - 大規模データセットで時間がかかる場合を考慮し、進捗表示や `sample_n` の調整オプションを CLI 引数で受け取れるよう検討する
  - API 呼び出しの失敗時にはわかりやすいエラーメッセージを返し、途中で取得済みの情報は破棄する

- `metadata/manager.py` の実装方針

  - 取得したスナップショット辞書を受け取り、`project/{project_id}/metadata.md`（フォルダがなければ作成）に Markdown を生成する
  - Markdown の章立て: プロジェクト概要、対象データセット一覧、各テーブルについてフィールド定義とサンプル行を表形式で記載する
  - 既存ファイルがある場合は上書き前にバックアップを作成するか、再生成である旨を表示して上書きする
  - 生成結果を CLI に返して保存先パスを案内する

- 付随するユーティリティの整備
  - メタデータ保存先ディレクトリの決定ロジックを `datastore/files.py` などで共通化する（未実装の場合は新設）
  - 単体テストの追加: プロジェクト選択とデータセット列挙関数の分岐、`metadata_snapshot` 呼び出しモック、Markdown 生成結果のスナップショットテスト
  - 実装時には `requirements.md` と `designdoc.md` に記載したフローと整合しているかを確認するチェックリストを用意する
