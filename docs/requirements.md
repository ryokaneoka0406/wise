## 概要

CLI で対話形式で利用できるデータ分析エージェントによって、自然言語による分析を実現する

## 課題

- BigQuery のクエリをかくのが面倒なので LLM に実施させているが、テーブル全体の構造を伝えるのが面倒
- Gemini の出力した SQL をコピペして BQ に貼るのも面倒
- 中間生成物データを保存したり、可視化するのも面倒

## ソリューション

CLI アプリケーションとして実装する

### 想定フロー

基本的なコンセプトは、CLI で自然言語をタイプすれば、それに応じたクエリ発行、データ取得、可視化、レポート作成を実行してくれる AI エージェント。

#### アカウント作成

- パッケージマネージャーでインストール
- `wise`: 起動
  - ウェルカムメッセージ
  - cli でのチャットスタート
- 初回実行時:
  - セットアップウィザードがスタート：CLI 経由で Google 認証
  - アカウント作成
  - Google BigQuery の読み込み権限を付与し、リフレッシュトークンと email を保存
- `/login` or `wise login`
  - 保存済みリフレッシュトークンを用いて再認証する（プロジェクトやデータセットの選択は行わない）

#### メタデータ作成

- `/init` or `wise init`
  - wise 起動中のチャット時に`/init` もしくは`wise init`で実行
  - CLI 上でアクセス可能な BigQuery プロジェクトを一覧し、ユーザーが対象プロジェクトを選択する
  - 選択したプロジェクト配下のすべてのデータセットについてテーブル構造を読み込み、メタデータファイルをマークダウンで作成する（/init コマンドで再実行できる）
    - データ全体の概要
      - 選択した PJ、配下データセット一覧
    - 各データのカラムとその意味
    - リレーション
      - ユーザーはマークダウンを編集可能
  - この際、列名と実際の value 両方を読み込み、メタデータを作成する
  - マークダウンファイルはプロジェクト直下に作成（`metadata.md`）
  - メタデータには選択したプロジェクトと配下のデータセット情報を保持し、後続のクエリ生成や分析で利用する

#### クエリ生成

- CLI に自然言語を入力してエンターするとメタデータを元に SQL を作成。そのまま実行するか、フィードバックするか選べる
- SQL 実行後、上位 5 行を CLI で表示
  - 10 行未満の場合は全て表示
- Yes/No で CSV 書き出しを提案
- Yes を選ぶと、`analyses/{要約}` フォルダを新規作成し、CSV と実行クエリを含むメタデータを保存する
  - フォルダ内に `metadata.md`（実行した SQL とテーブルのメタデータ）、`result.csv` を保存
  - フォルダ名は実行の狙いを要約したもの

#### 分析

- チャット欄で@で任意のフォルダ（1 のクエリ生成で作ったもの）を指定した上で命令すると分析モード
- データを確認した示唆を `analysis.md` に書き出す

#### 可視化

- チャット欄で@でクエリ生成機能で作った任意のフォルダを指定した上で可視化に関する命令をすると可視化モード
- データを可視化し、画像を同じフォルダに保存（例: `visualization_{要約}.png`）
