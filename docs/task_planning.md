# 開発タスク計画

本ドキュメントは `docs/designdoc.md` に基づき、`wise` プロジェクトを実装するための開発タスクを順序立てて記述する。
不明点が多い項目は調査タスクとして明示する。

## フェーズ 0: 調査・共通基盤

1. **開発環境の決定とセットアップ**
   - 使用言語・バージョン、パッケージ管理方法を決める。
   - 仮想環境、テストフレームワーク、フォーマッタを整備する。
2. **BigQuery API の利用方法調査**
   - 認証フロー、必要スコープ、Python クライアントライブラリの動作を確認する。
3. **LLM サービスの選定**
   - 利用可能な API、レート制限、プロンプト設計の制約を調査する。

## フェーズ 1: プロジェクト骨格の構築

1. **Python パッケージ構成の作成**
   - `wise/` 以下に設計書のディレクトリ構造を雛形として用意する。
   - `__init__.py`, `cli.py` など最低限のエントリーポイントを追加。
2. **内部 DB モデルの初期実装**
   - SQLite を用いて `accounts`, `datasets`, `analysis`, `queries`, `sessions`, `messages` テーブルを定義する。
   - DB 初期化処理と簡易的な CRUD を用意する。

## フェーズ 2: 認証と BigQuery 接続

1. **CLI セットアップウィザードの実装**
   - 初回起動時に Google 認証を行い、リフレッシュトークンを保存するフローを作成。
2. **BigQuery クライアントの作成**
   - 認証情報から BigQuery API を呼び出すラッパー `bq/client.py` を実装。
3. **`/login` コマンドの実装**
   - 再ログイン処理と BigQuery プロジェクト・データセットの再設定。

## フェーズ 3: メタデータ生成機能

1. **`/init` コマンド実装**
   - 指定データセットのテーブル構造・サンプル値を取得。
   - `metadata/manager.py` で Markdown 形式の `data.md` を生成する。
   - 既存メタデータの更新・再生成にも対応。

## フェーズ 4: チャットインターフェース

1. **対話セッション管理**
   - `chat/session.py` でユーザーとの対話ループと会話ログ保存を実装。
2. **コマンドハンドラ**
   - `chat/commands.py` で `/login`、`/init` などのコマンド処理を追加。

## フェーズ 5: LLM エンジン

1. **共通ラッパー `llm/base.py`**
   - API キー設定、リトライ、プロンプト送信の共通処理を実装。
2. **SQL 生成モジュール `llm/sql.py`**
   - メタデータをプロンプトに含め、SQL 文を生成。
3. **分析用モジュール `llm/analysis.py`**
   - CSV を読み込ませて示唆を出力するプロンプト設計。
4. **可視化指示モジュール `llm/visualize.py`**
   - グラフ種類や軸情報を受け取り描画コードを生成。

## フェーズ 6: クエリ生成と実行

1. **自然言語から SQL の生成フロー**
   - ユーザー入力を受け取り SQL を提案、承認後に実行する流れを構築。
2. **実行結果の表示と保存**
   - 上位 5 行 (10 行未満の場合は全行) を CLI に表示。
   - CSV とメタデータをフォルダへ保存し、フォルダ名は目的の要約とする。
3. **履歴の DB 保存**
   - 実行した SQL や分析フォルダ情報を `queries` などのテーブルに記録。

## フェーズ 7: 分析モード

1. **フォルダ指定による分析実行**
   - `analysis/runner.py` で CSV を読み込み、LLM による示唆を `analysis.md` に出力。
2. **追加指示の処理**
   - 同フォルダで追加の分析結果を追記できるようにする。

## フェーズ 8: 可視化モード

1. **可視化指示の解析**
   - `visualization/plot.py` で LLM から得た指示を基にグラフを生成。
2. **画像ファイルの保存**
   - 生成した画像を `visualization.png` として指定フォルダへ保存。

## フェーズ 9: データストア機能

1. **ファイル操作ユーティリティ `datastore/files.py`**
   - CSV、メタデータ、分析結果、画像の保存と読み込みを共通化。
2. **フォルダ命名の自動化**
   - 分析目的の要約に基づきフォルダを自動作成するロジック。

## フェーズ 10: テスト・ドキュメンテーション

1. **ユニットテストの整備**
   - 各モジュールごとにテストケースを追加。
2. **開発ドキュメント整備**
   - 使用方法、コマンド一覧、拡張方法を `README` などに記載。
3. **パッケージ配布設定**
   - `pyproject.toml` などを整備し、インストール可能な形にする。

## 将来の拡張に向けた検討タスク

- 追加データソースや BI ツール連携の技術調査。
- 分析テンプレート共有機能の実装方法の検討。
- 複数ユーザーコラボレーション機能の要件整理。
